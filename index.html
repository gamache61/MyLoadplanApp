<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAR</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="apple-touch-icon" href="icon.svg">
    
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    
    <meta name="theme-color" content="#ffffff">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        
        /* Camera Container Styling */
        #scanner-container { 
            width: 100%; 
            max-width: 600px; 
            height: 300px; 
            margin: 0 auto; 
            background: #eee; 
            border: 2px dashed #ccc;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
        
        /* Force video to fill the box */
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Green box overlay when scanning */
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }

        #result, #total { font-size: 1.2em; margin: 10px; }
        #cart { list-style: none; padding: 0; }
        #cart li { margin: 5px 0; border-bottom: 1px solid #ddd; padding: 5px; }
        
        .error-msg { color: red; font-weight: bold; padding: 20px; display: block; }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>BAR</h1>
    
    <div id="scanner-container"></div>

    <br>
    <input type="number" id="tax-rate" placeholder="Enter tax rate (%)" step="0.01" min="0" style="padding: 8px;">
    <br>
    <button onclick="startScanner()">Start Scanner</button>
    
    <div id="result">Scan a barcode...</div>
    
    <ul id="cart"></ul>
    <div id="total">Total: $0.00</div>

    <script>
        // === APP LOGIC ===
        const items = {
            '123456789012': { name: 'Item 1', price: 10.00 },
            '987654321098': { name: 'Item 2', price: 15.50 },
        };
        let cart = [];
        let taxRate = 0;

        document.getElementById('tax-rate').addEventListener('input', (e) => {
            taxRate = parseFloat(e.target.value) / 100 || 0;
            updateTotal();
        });

        function startScanner() {
            // Check if user is opening file directly (Safety Check)
            if (location.protocol === 'file:') {
                alert("ERROR: Camera Blocked!\n\nYou are opening this as a file. You MUST drag this folder to Netlify (or use a server) for the camera to work.");
                return;
            }

            // Check if browser supports camera
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser does not support camera access.");
                return;
            }

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment" // Uses back camera
                    }
                },
                decoder: { readers: ["upc_reader", "ean_reader"] }
            }, (err) => {
                if (err) {
                    console.error(err);
                    alert("Camera failed to start. Did you allow permissions?");
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected((data) => {
                const code = data.codeResult.code;
                document.getElementById('result').textContent = `Scanned: ${code}`;
                addToCart(code);
                Quagga.stop();
                setTimeout(startScanner, 1000); 
            });
        }

        function addToCart(code) {
            const item = items[code];
            if (item) {
                cart.push(item);
                const li = document.createElement('li');
                li.textContent = `${item.name} - $${item.price.toFixed(2)}`;
                document.getElementById('cart').appendChild(li);
                updateTotal();
            } else {
                alert('Item not found: ' + code);
            }
        }

        function updateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            document.getElementById('total').textContent = `Total: $${total.toFixed(2)} (Subtotal: $${subtotal.toFixed(2)}, Tax: $${tax.toFixed(2)})`;
        }

        // === CONNECT THE BRAIN ===
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((reg) => console.log('BAR Brain loaded!', reg))
                    .catch((err) => console.log('BAR Brain failed:', err));
            });
        }
    </script>
</body>
</html>
