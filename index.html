<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loadmaster 3D Max View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/DragControls.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #111827; color: #f3f4f6; overflow: hidden; height: 100vh; margin: 0; }
        .app-wrapper { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 120px; background: #1f2937; display: flex; flex-direction: column; padding: 10px; gap: 12px; flex-shrink: 0; border-right: 1px solid #374151; z-index: 10; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; background: #000; }
        #canvas-container { flex-grow: 1; width: 100%; background: #000; overflow: hidden; position: relative; border-bottom: 2px solid #374151; }
        .side-btn { padding: 15px 5px; font-size: 15px; font-weight: 700; text-align: center; border-radius: 8px; background: #374151; color: #9ca3af; cursor: pointer; border: 2px solid #4b5563; transition: 0.2s; line-height: 1.3; }
        .side-btn.active-tab { background: #22c55e; color: #ffffff; border-color: #4ade80; }
        .btn-teal { background: #0f766e; border-color: #14b8a6; color: white; }
        .btn-indigo { background: #4338ca; border-color: #6366f1; color: white; }
        .btn-blue { background: #1d4ed8; border-color: #3b82f6; color: white; }
        .btn-red { background: #b91c1c; border-color: #ef4444; color: white; }
        .bottom-panel { background: #1f2937; padding: 10px; border-top: 1px solid #374151; flex-shrink: 0; }
        input, select { padding: 8px; margin: 2px 0; border: 1px solid #4b5563; border-radius: 6px; background: #374151; color: white; width: 100%; font-size: 14px; }
        .action-btn { padding: 10px; border-radius: 6px; cursor: pointer; background: #10b981; color: white; font-weight: bold; width: 100%; border:none;}
        .tab-content { display: none; height: 100%; flex-direction: column; }
        .tab-content.active { display: flex; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        .list-item { background: #111827; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 5px solid #34d399; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-wrapper">
    <div class="sidebar">
        <button class="side-btn active-tab" onclick="switchTab('main')">3D<br>PLAN</button>
        <button class="side-btn" onclick="switchTab('customers')">CUST<br>LIST</button>
        <button class="side-btn" onclick="switchTab('library')">ITEM<br>LIB</button>
        <button class="side-btn" onclick="switchTab('trailers')">TRAIL<br>SIZE</button>
    </div>

    <div class="main-content">
        <div id="main-tab" class="tab-content active">
            <div id="canvas-container"></div>
            <div class="bottom-panel">
                <div class="flex gap-2 mb-2">
                    <select id="cust-select" class="flex-1"><option>Customer...</option></select>
                    <select id="item-select" class="flex-1"><option>Item...</option></select>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="load-wt" placeholder="Weight (lbs)" style="flex:1;">
                    <button class="action-btn" style="flex:2;" onclick="addLoad()">+ ADD TO LOAD</button>
                </div>
                <div class="mt-1 text-center text-xs text-gray-500" id="load-summary">0 items | 0 lbs</div>
            </div>
        </div>

        <div id="customers-tab" class="tab-content">
            <div class="bg-gray-800 p-4">
                <h2 class="text-xl font-bold text-green-500 mb-2">Customers</h2>
                <input id="c-name" placeholder="Name" class="mb-2">
                <button onclick="saveCustomer()" class="action-btn">ADD CUSTOMER</button>
            </div>
            <div class="scroll-area" id="cust-list"></div>
        </div>

        <div id="library-tab" class="tab-content">
            <div class="bg-gray-800 p-4">
                <h2 class="text-xl font-bold text-green-500 mb-2">Item Library</h2>
                <input id="lib-name" placeholder="Item Name" class="mb-2">
                <div class="flex gap-2 mb-2">
                    <input type="number" id="lib-l" placeholder="L">
                    <input type="number" id="lib-w" placeholder="W">
                    <input type="number" id="lib-h" placeholder="H">
                </div>
                <input type="color" id="lib-color" value="#22c55e" class="mb-2">
                <button class="action-btn" onclick="saveLibItem()">SAVE ITEM</button>
            </div>
            <div class="scroll-area" id="library-list"></div>
        </div>

        <div id="trailers-tab" class="tab-content">
            <div class="bg-gray-800 p-4">
                <h2 class="text-xl font-bold text-green-500 mb-2">Trailers</h2>
                <input id="t-name" placeholder="Trailer Name" class="mb-2">
                <div class="flex gap-2 mb-2">
                    <input type="number" id="t-l" placeholder="L (ft)">
                    <input type="number" id="t-w" placeholder="W (ft)">
                    <input type="number" id="t-h" placeholder="H (ft)">
                </div>
                <button class="action-btn" onclick="saveTrailer()">ADD TRAILER</button>
            </div>
            <div class="scroll-area" id="trailer-list"></div>
        </div>
    </div>

    <div class="sidebar sidebar-right">
        <button class="side-btn btn-teal" onclick="exportLoad()">SAVE<br>LOAD</button>
        <button class="side-btn btn-indigo" onclick="exportCustomers()">SAVE<br>CUST</button>
        <input type="file" id="file-input" class="hidden" onchange="importData(this)">
        <button class="side-btn btn-blue" onclick="document.getElementById('file-input').click()">IMPORT<br>FILE</button>
        <div id="side-delete-wrapper" class="hidden mt-4 pt-4 border-t border-gray-600">
            <button class="side-btn btn-red" onclick="deleteSelected()">DELETE<br>ITEM</button>
        </div>
        <div style="flex-grow:1"></div> 
        <button class="side-btn btn-red" onclick="hardReset()">RESET<br>APP</button>
    </div>
</div>

<script>
    const STORAGE_KEY = "loadmaster_data_v1";
    let app = {
        customers: [],
        library: [],
        trailers: [{id: 1, name: "Standard 53'", l: 636, w: 102, h: 110}],
        activeTrailer: 1,
        load: []
    };
    let selectedUID = null;
    let scene, camera, renderer, orbit, dragControls;
    let meshes = [], trailerMesh, floorMesh;
    const SCALAR = 0.05;

    window.onload = () => {
        initData();
        renderUI();
        init3D();
        window.addEventListener('resize', onResize);
    };

    function initData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // Merge loaded data with defaults to prevent crashes
                app = { ...app, ...parsed };
                console.log("Data loaded successfully:", app);
            } catch (e) {
                console.error("Failed to parse saved data:", e);
            }
        }
    }

    function saveToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(app));
        console.log("Saved to LocalStorage");
    }

    // --- LOGIC: BACK TO FRONT LOADING ---
    function addLoad() {
        const cId = document.getElementById('cust-select').value;
        const iId = document.getElementById('item-select').value;
        const weight = parseFloat(document.getElementById('load-wt').value) || 0;
        if(cId === "Customer..." || iId === "Item...") return;

        const itemTemplate = app.library.find(x => x.id == iId);
        const trailer = app.trailers.find(x => x.id === app.activeTrailer);

        // Logic: Start at back wall, find furthest forward point
        let furthestFront = trailer.l; 
        app.load.forEach(i => { if(i.x < furthestFront) furthestFront = i.x; });

        // Position new item behind the current load
        let newX = furthestFront - itemTemplate.l;
        if (newX < 0) newX = 0; // Don't go through the front wall

        app.load.push({
            uid: Date.now(), name: itemTemplate.name, l: itemTemplate.l, w: itemTemplate.w, h: itemTemplate.h, 
            wt: weight, color: itemTemplate.color, x: newX, y: 0, z: 0, cId: cId
        });
        saveAndRefresh();
    }

    function saveAndRefresh() {
        saveToStorage();
        renderUI();
        buildLoad3D();
    }

    // --- 3D SYSTEM ---
    function init3D() {
        const cont = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(50, cont.clientWidth/cont.clientHeight, 0.1, 1000);
        camera.position.set(50, 50, 50);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(cont.clientWidth, cont.clientHeight);
        cont.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.9));
        orbit = new THREE.OrbitControls(camera, renderer.domElement);
        buildTrailer3D(); buildLoad3D(); animate();
    }

    function buildTrailer3D() {
        if(trailerMesh) scene.remove(trailerMesh);
        const t = app.trailers.find(x => x.id === app.activeTrailer);
        const geo = new THREE.BoxGeometry(t.l*SCALAR, t.h*SCALAR, t.w*SCALAR);
        trailerMesh = new THREE.LineSegments(new THREE.EdgesGeometry(geo), new THREE.LineBasicMaterial({color: 0x22c55e}));
        trailerMesh.position.y = (t.h*SCALAR)/2;
        scene.add(trailerMesh);
    }

    function buildLoad3D() {
        meshes.forEach(m => scene.remove(m)); meshes = [];
        if(dragControls) dragControls.dispose();
        const t = app.trailers.find(x => x.id === app.activeTrailer);

        app.load.forEach(item => {
            const mesh = new THREE.Mesh(
                new THREE.BoxGeometry(item.l*SCALAR, item.h*SCALAR, item.w*SCALAR),
                new THREE.MeshLambertMaterial({ color: item.color })
            );
            mesh.position.set(
                (item.x*SCALAR) - ((t.l*SCALAR)/2) + ((item.l*SCALAR)/2),
                (item.y*SCALAR) + ((item.h*SCALAR)/2),
                (item.z*SCALAR) - ((t.w*SCALAR)/2) + ((item.w*SCALAR)/2)
            );
            mesh.userData = { uid: item.uid };
            scene.add(mesh); meshes.push(mesh);
        });

        dragControls = new THREE.DragControls(meshes, camera, renderer.domElement);
        dragControls.addEventListener('dragstart', (e) => { 
            orbit.enabled = false; 
            selectedUID = e.object.userData.uid;
            document.getElementById('side-delete-wrapper').classList.remove('hidden');
        });

        // FIXED BOUNDARY SNAPPING
        dragControls.addEventListener('drag', (e) => {
            const m = e.object;
            const i = app.load.find(x => x.uid === m.userData.uid);
            const hL = (t.l*SCALAR)/2; const hW = (t.w*SCALAR)/2;

            if(m.position.x - (i.l*SCALAR)/2 < -hL) m.position.x = -hL + (i.l*SCALAR)/2;
            if(m.position.x + (i.l*SCALAR)/2 > hL) m.position.x = hL - (i.l*SCALAR)/2;
            if(m.position.z - (i.w*SCALAR)/2 < -hW) m.position.z = -hW + (i.w*SCALAR)/2;
            if(m.position.z + (i.w*SCALAR)/2 > hW) m.position.z = hW - (i.w*SCALAR)/2;
            if(m.position.y < (i.h*SCALAR)/2) m.position.y = (i.h*SCALAR)/2;

            i.x = (m.position.x + hL - (i.l*SCALAR)/2) / SCALAR;
            i.z = (m.position.z + hW - (i.w*SCALAR)/2) / SCALAR;
            i.y = (m.position.y - (i.h*SCALAR)/2) / SCALAR;
        });

        dragControls.addEventListener('dragend', () => { orbit.enabled = true; saveToStorage(); });
    }

    // --- UI & TAB HELPERS ---
    function renderUI() {
        document.getElementById('cust-select').innerHTML = "<option>Customer...</option>" + app.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        document.getElementById('item-select').innerHTML = "<option>Item...</option>" + app.library.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
        document.getElementById('cust-list').innerHTML = app.customers.map(c => `<div class="list-item"><b>${c.name}</b></div>`).join('');
        document.getElementById('library-list').innerHTML = app.library.map(i => `<div class="list-item" style="border-color:${i.color}"><b>${i.name}</b></div>`).join('');
        document.getElementById('trailer-list').innerHTML = app.trailers.map(t => `<div class="list-item"><b>${t.name}</b></div>`).join('');
        document.getElementById('load-summary').innerText = `${app.load.length} items | ${app.load.reduce((a,b)=>a+(b.wt||0),0).toLocaleString()} lbs`;
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(id + '-tab').classList.add('active');
        if(id === 'main') setTimeout(onResize, 50);
    }

    function saveCustomer() { const n = document.getElementById('c-name').value; if(n) app.customers.push({id:Date.now(), name:n}); saveAndRefresh(); }
    function saveLibItem() { const n = document.getElementById('lib-name').value; const l=Number(document.getElementById('lib-l').value); const w=Number(document.getElementById('lib-w').value); const h=Number(document.getElementById('lib-h').value); const c=document.getElementById('lib-color').value; if(n&&l) app.library.push({id:Date.now(), name:n, l, w, h, color:c}); saveAndRefresh(); }
    function saveTrailer() { const n = document.getElementById('t-name').value; const l=Number(document.getElementById('t-l').value)*12; const w=Number(document.getElementById('t-w').value)*12; const h=Number(document.getElementById('t-h').value)*12; if(n&&l) app.trailers.push({id:Date.now(), name:n, l, w, h}); saveAndRefresh(); }
    function deleteSelected() { app.load = app.load.filter(i => i.uid !== selectedUID); document.getElementById('side-delete-wrapper').classList.add('hidden'); saveAndRefresh(); }
    
    function exportLoad() { downloadJSON(app, "LoadPlan.json"); }
    function exportCustomers() { downloadJSON({customers:app.customers, library:app.library}, "CustData.json"); }
    function downloadJSON(obj, name) { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(obj)],{type:'application/json'})); a.download=name; a.click(); }
    
    function importData(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(json.load) app = { ...app, ...json };
                else if(json.customers) app = { ...app, ...json };
                saveAndRefresh();
                alert("Import Successful");
            } catch(err) { alert("Invalid File"); }
        };
        reader.readAsText(input.files[0]);
    }

    function animate() { requestAnimationFrame(animate); orbit.update(); renderer.render(scene, camera); }
    function onResize() { const c = document.getElementById('canvas-container'); camera.aspect = c.clientWidth/c.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(c.clientWidth, c.clientHeight); }
    function hardReset() { if(confirm("Wipe everything?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>